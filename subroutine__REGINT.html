<html>
  <link REL="STYLESHEET" HREF="syntax.css" TYPE="text/css">
  <body>
    <table cellpadding="20" border="1">
      <thead>
        <tr>
        <td colspan="2"><center><h1>nbody6</h1></center>
<table width="100%">
  <tbody>
    <tr>
      <td width="30%" align="center"><a href="project__nbody6.html">Home</a></td>
      <td width="40%" align="center"><a href="call_project__nbody6.html">Call tree</a></td>
      <td width="30%" align="center"><a href="tree_project__nbody6.html">Structure tree</a></td>
    </tr>
  </tbody>
</table>

</td>
    </tr>
      </thead>
      <tbody>
        <tr>
          <td width="10%" align="left" valign="top"><ul>
  <li><a href="File__absorb.f.html">absorb.f</a></li>
</ul><ul>
  <li><a href="File__adjust.F.html">adjust.F</a></li>
</ul><ul>
  <li><a href="File__bindat.F.html">bindat.F</a></li>
</ul><ul>
  <li><a href="File__binout.f.html">binout.f</a></li>
</ul><ul>
  <li><a href="File__binpop.F.html">binpop.F</a></li>
</ul><ul>
  <li><a href="File__binpop_old.f.html">binpop_old.f</a></li>
</ul><ul>
  <li><a href="File__binpop_pk.f.html">binpop_pk.f</a></li>
</ul><ul>
  <li><a href="File__block.f.html">block.f</a></li>
</ul><ul>
  <li><a href="File__bodies.f.html">bodies.f</a></li>
</ul><ul>
  <li><a href="File__brake.f.html">brake.f</a></li>
</ul><ul>
  <li><a href="File__cfuncs.f.html">cfuncs.f</a></li>
</ul><ul>
  <li><a href="File__chain.f.html">chain.f</a></li>
</ul><ul>
  <li><a href="File__chdata.f.html">chdata.f</a></li>
</ul><ul>
  <li><a href="File__check.f.html">check.f</a></li>
</ul><ul>
  <li><a href="File__checkl.f.html">checkl.f</a></li>
</ul><ul>
  <li><a href="File__chfind.f.html">chfind.f</a></li>
</ul><ul>
  <li><a href="File__chfirr.f.html">chfirr.f</a></li>
</ul><ul>
  <li><a href="File__chinit.f.html">chinit.f</a></li>
</ul><ul>
  <li><a href="File__chlist.f.html">chlist.f</a></li>
</ul><ul>
  <li><a href="File__chmod.f.html">chmod.f</a></li>
</ul><ul>
  <li><a href="File__chpot.f.html">chpot.f</a></li>
</ul><ul>
  <li><a href="File__chstab.f.html">chstab.f</a></li>
</ul><ul>
  <li><a href="File__chterm.f.html">chterm.f</a></li>
</ul><ul>
  <li><a href="File__clint.f.html">clint.f</a></li>
</ul><ul>
  <li><a href="File__cloud.f.html">cloud.f</a></li>
</ul><ul>
  <li><a href="File__cloud0.F.html">cloud0.F</a></li>
</ul><ul>
  <li><a href="File__cmbody.f.html">cmbody.f</a></li>
</ul><ul>
  <li><a href="File__cmcorr.f.html">cmcorr.f</a></li>
</ul><ul>
  <li><a href="File__cmfirr.f.html">cmfirr.f</a></li>
</ul><ul>
  <li><a href="File__cmfreg.f.html">cmfreg.f</a></li>
</ul><ul>
  <li><a href="File__const.f.html">const.f</a></li>
</ul><ul>
  <li><a href="File__core.f.html">core.f</a></li>
</ul><ul>
  <li><a href="File__cputim.F.html">cputim.F</a></li>
</ul><ul>
  <li><a href="File__cstab2.f.html">cstab2.f</a></li>
</ul><ul>
  <li><a href="File__cstab3.f.html">cstab3.f</a></li>
</ul><ul>
  <li><a href="File__cstab4.f.html">cstab4.f</a></li>
</ul><ul>
  <li><a href="File__cstab5.f.html">cstab5.f</a></li>
</ul><ul>
  <li><a href="File__data.F.html">data.F</a></li>
</ul><ul>
  <li><a href="File__define.f.html">define.f</a></li>
</ul><ul>
  <li><a href="File__delay.f.html">delay.f</a></li>
</ul><ul>
  <li><a href="File__derqp.f.html">derqp.f</a></li>
</ul><ul>
  <li><a href="File__derqp3.f.html">derqp3.f</a></li>
</ul><ul>
  <li><a href="File__derqp4.f.html">derqp4.f</a></li>
</ul><ul>
  <li><a href="File__difsy1.f.html">difsy1.f</a></li>
</ul><ul>
  <li><a href="File__difsy3.f.html">difsy3.f</a></li>
</ul><ul>
  <li><a href="File__difsy4.f.html">difsy4.f</a></li>
</ul><ul>
  <li><a href="File__efac2.f.html">efac2.f</a></li>
</ul><ul>
  <li><a href="File__efac3.f.html">efac3.f</a></li>
</ul><ul>
  <li><a href="File__eigenvalue.f.html">eigenvalue.f</a></li>
</ul><ul>
  <li><a href="File__ellan.f.html">ellan.f</a></li>
</ul><ul>
  <li><a href="File__endreg.f.html">endreg.f</a></li>
</ul><ul>
  <li><a href="File__energy.f.html">energy.f</a></li>
</ul><ul>
  <li><a href="File__energy_mpi.f.html">energy_mpi.f</a></li>
</ul><ul>
  <li><a href="File__erel.f.html">erel.f</a></li>
</ul><ul>
  <li><a href="File__erel3.f.html">erel3.f</a></li>
</ul><ul>
  <li><a href="File__erel4.f.html">erel4.f</a></li>
</ul><ul>
  <li><a href="File__escape.F.html">escape.F</a></li>
</ul><ul>
  <li><a href="File__events.f.html">events.f</a></li>
</ul><ul>
  <li><a href="File__evolve.f.html">evolve.f</a></li>
</ul><ul>
  <li><a href="File__expand.f.html">expand.f</a></li>
</ul><ul>
  <li><a href="File__extend.f.html">extend.f</a></li>
</ul><ul>
  <li><a href="File__fchain.f.html">fchain.f</a></li>
</ul><ul>
  <li><a href="File__fclose.f.html">fclose.f</a></li>
</ul><ul>
  <li><a href="File__fcloud.f.html">fcloud.f</a></li>
</ul><ul>
  <li><a href="File__fcorr.f.html">fcorr.f</a></li>
</ul><ul>
  <li><a href="File__ficorr.f.html">ficorr.f</a></li>
</ul><ul>
  <li><a href="File__file_init.F.html">file_init.F</a></li>
</ul><ul>
  <li><a href="File__findj.f.html">findj.f</a></li>
</ul><ul>
  <li><a href="File__flush.f.html">flush.f</a></li>
</ul><ul>
  <li><a href="File__flush.t3e.f.html">flush.t3e.f</a></li>
</ul><ul>
  <li><a href="File__flyby.f.html">flyby.f</a></li>
</ul><ul>
  <li><a href="File__fpcorr.f.html">fpcorr.f</a></li>
</ul><ul>
  <li><a href="File__fpert.f.html">fpert.f</a></li>
</ul><ul>
  <li><a href="File__fpoly1.f.html">fpoly1.f</a></li>
</ul><ul>
  <li><a href="File__fpoly1_mpi.f.html">fpoly1_mpi.f</a></li>
</ul><ul>
  <li><a href="File__fpoly2.f.html">fpoly2.f</a></li>
</ul><ul>
  <li><a href="File__fpoly2_mpi.f.html">fpoly2_mpi.f</a></li>
</ul><ul>
  <li><a href="File__freeze.f.html">freeze.f</a></li>
</ul><ul>
  <li><a href="File__ghost.f.html">ghost.f</a></li>
</ul><ul>
  <li><a href="File__gntage.f.html">gntage.f</a></li>
</ul><ul>
  <li><a href="File__hcorr.f.html">hcorr.f</a></li>
</ul><ul>
  <li><a href="File__hiarch.f.html">hiarch.f</a></li>
</ul><ul>
  <li><a href="File__hidat.f.html">hidat.f</a></li>
</ul><ul>
  <li><a href="File__himax.f.html">himax.f</a></li>
</ul><ul>
  <li><a href="File__himax2.f.html">himax2.f</a></li>
</ul><ul>
  <li><a href="File__hipop.F.html">hipop.F</a></li>
</ul><ul>
  <li><a href="File__histab.f.html">histab.f</a></li>
</ul><ul>
  <li><a href="File__hivel.f.html">hivel.f</a></li>
</ul><ul>
  <li><a href="File__hmdot.f.html">hmdot.f</a></li>
</ul><ul>
  <li><a href="File__hmdot2.f.html">hmdot2.f</a></li>
</ul><ul>
  <li><a href="File__hotsys.F.html">hotsys.F</a></li>
</ul><ul>
  <li><a href="File__hpsort.f.html">hpsort.f</a></li>
</ul><ul>
  <li><a href="File__hrdiag.f.html">hrdiag.f</a></li>
</ul><ul>
  <li><a href="File__hrplot.f.html">hrplot.f</a></li>
</ul><ul>
  <li><a href="File__iblock.f.html">iblock.f</a></li>
</ul><ul>
  <li><a href="File__ichain.f.html">ichain.f</a></li>
</ul><ul>
  <li><a href="File__imf.f.html">imf.f</a></li>
</ul><ul>
  <li><a href="File__imf2.f.html">imf2.f</a></li>
</ul><ul>
  <li><a href="File__imfbd.f.html">imfbd.f</a></li>
</ul><ul>
  <li><a href="File__impact.f.html">impact.f</a></li>
</ul><ul>
  <li><a href="File__inclin.f.html">inclin.f</a></li>
</ul><ul>
  <li><a href="File__indexx.f.html">indexx.f</a></li>
</ul><ul>
  <li><a href="File__inext.f.html">inext.f</a></li>
</ul><ul>
  <li><a href="File__input.F.html">input.F</a></li>
</ul><ul>
  <li><a href="File__insert.f.html">insert.f</a></li>
</ul><ul>
  <li><a href="File__instar.f.html">instar.f</a></li>
</ul><ul>
  <li><a href="File__intgrt.F.html">intgrt.F</a></li>
</ul><ul>
  <li><a href="File__intide.F.html">intide.F</a></li>
</ul><ul>
  <li><a href="File__invert.f.html">invert.f</a></li>
</ul><ul>
  <li><a href="File__kcpert.f.html">kcpert.f</a></li>
</ul><ul>
  <li><a href="File__kepler.f.html">kepler.f</a></li>
</ul><ul>
  <li><a href="File__kick.f.html">kick.f</a></li>
</ul><ul>
  <li><a href="File__ksapo.f.html">ksapo.f</a></li>
</ul><ul>
  <li><a href="File__kscorr.f.html">kscorr.f</a></li>
</ul><ul>
  <li><a href="File__ksin2.f.html">ksin2.f</a></li>
</ul><ul>
  <li><a href="File__ksinit.f.html">ksinit.f</a></li>
</ul><ul>
  <li><a href="File__ksint.F.html">ksint.F</a></li>
</ul><ul>
  <li><a href="File__kslist.f.html">kslist.f</a></li>
</ul><ul>
  <li><a href="File__ksmod.f.html">ksmod.f</a></li>
</ul><ul>
  <li><a href="File__ksperi.f.html">ksperi.f</a></li>
</ul><ul>
  <li><a href="File__kspert.f.html">kspert.f</a></li>
</ul><ul>
  <li><a href="File__ksphys.f.html">ksphys.f</a></li>
</ul><ul>
  <li><a href="File__kspoly.f.html">kspoly.f</a></li>
</ul><ul>
  <li><a href="File__kspred.f.html">kspred.f</a></li>
</ul><ul>
  <li><a href="File__ksrect.f.html">ksrect.f</a></li>
</ul><ul>
  <li><a href="File__ksreg.f.html">ksreg.f</a></li>
</ul><ul>
  <li><a href="File__ksres.f.html">ksres.f</a></li>
</ul><ul>
  <li><a href="File__ksres2.f.html">ksres2.f</a></li>
</ul><ul>
  <li><a href="File__ksterm.f.html">ksterm.f</a></li>
</ul><ul>
  <li><a href="File__kstide.f.html">kstide.f</a></li>
</ul><ul>
  <li><a href="File__lagr.F.html">lagr.F</a></li>
</ul><ul>
  <li><a href="File__levels.f.html">levels.f</a></li>
</ul><ul>
  <li><a href="File__matrix.f.html">matrix.f</a></li>
</ul><ul>
  <li><a href="File__mdot.f.html">mdot.f</a></li>
</ul><ul>
  <li><a href="File__merge.f.html">merge.f</a></li>
</ul><ul>
  <li><a href="File__merge2.f.html">merge2.f</a></li>
</ul><ul>
  <li><a href="File__mloss.f.html">mloss.f</a></li>
</ul><ul>
  <li><a href="File__mlwind.f.html">mlwind.f</a></li>
</ul><ul>
  <li><a href="File__modify.F.html">modify.F</a></li>
</ul><ul>
  <li><a href="File__mydump.F.html">mydump.F</a></li>
</ul><ul>
  <li><a href="File__nbint.f.html">nbint.f</a></li>
</ul><ul>
  <li><a href="File__nblist.f.html">nblist.f</a></li>
</ul><ul>
  <li><a href="File__nbody6.F.html">nbody6.F</a></li>
</ul><ul>
  <li><a href="File__nbpot.f.html">nbpot.f</a></li>
</ul><ul>
  <li><a href="File__nbrem.f.html">nbrem.f</a></li>
</ul><ul>
  <li><a href="File__nbrest.f.html">nbrest.f</a></li>
</ul><ul>
  <li><a href="File__nbsort.f.html">nbsort.f</a></li>
</ul><ul>
  <li><a href="File__nbtide.f.html">nbtide.f</a></li>
</ul><ul>
  <li><a href="File__newreg.f.html">newreg.f</a></li>
</ul><ul>
  <li><a href="File__newsys.f.html">newsys.f</a></li>
</ul><ul>
  <li><a href="File__nlmod.f.html">nlmod.f</a></li>
</ul><ul>
  <li><a href="File__offset.f.html">offset.f</a></li>
</ul><ul>
  <li><a href="File__orbit.f.html">orbit.f</a></li>
</ul><ul>
  <li><a href="File__output.F.html">output.F</a></li>
</ul><ul>
  <li><a href="File__peri.f.html">peri.f</a></li>
</ul><ul>
  <li><a href="File__permit.f.html">permit.f</a></li>
</ul><ul>
  <li><a href="File__pfac.f.html">pfac.f</a></li>
</ul><ul>
  <li><a href="File__physks.f.html">physks.f</a></li>
</ul><ul>
  <li><a href="File__qforce.f.html">qforce.f</a></li>
</ul><ul>
  <li><a href="File__qpmod.f.html">qpmod.f</a></li>
</ul><ul>
  <li><a href="File__qpmod3.f.html">qpmod3.f</a></li>
</ul><ul>
  <li><a href="File__qpmod4.f.html">qpmod4.f</a></li>
</ul><ul>
  <li><a href="File__quad.f.html">quad.f</a></li>
</ul><ul>
  <li><a href="File__r2sort.f.html">r2sort.f</a></li>
</ul><ul>
  <li><a href="File__ran2.f.html">ran2.f</a></li>
</ul><ul>
  <li><a href="File__rchain.f.html">rchain.f</a></li>
</ul><ul>
  <li><a href="File__recoil.f.html">recoil.f</a></li>
</ul><ul>
  <li><a href="File__redraw.f.html">redraw.f</a></li>
</ul><ul>
  <li><a href="File__reduce.f.html">reduce.f</a></li>
</ul><ul>
  <li><a href="File__reflct.f.html">reflct.f</a></li>
</ul><ul>
  <li><a href="File__regint.f.html">regint.f</a></li>
</ul><ul>
  <li><a href="File__reinit.f.html">reinit.f</a></li>
</ul><ul>
  <li><a href="File__remove.f.html">remove.f</a></li>
</ul><ul>
  <li><a href="File__rename.f.html">rename.f</a></li>
</ul><ul>
  <li><a href="File__renew.f.html">renew.f</a></li>
</ul><ul>
  <li><a href="File__reset.f.html">reset.f</a></li>
</ul><ul>
  <li><a href="File__reset2.f.html">reset2.f</a></li>
</ul><ul>
  <li><a href="File__resolv.f.html">resolv.f</a></li>
</ul><ul>
  <li><a href="File__resort.f.html">resort.f</a></li>
</ul><ul>
  <li><a href="File__rsort.f.html">rsort.f</a></li>
</ul><ul>
  <li><a href="File__rssort.f.html">rssort.f</a></li>
</ul><ul>
  <li><a href="File__scale.F.html">scale.F</a></li>
</ul><ul>
  <li><a href="File__search.f.html">search.f</a></li>
</ul><ul>
  <li><a href="File__select.f.html">select.f</a></li>
</ul><ul>
  <li><a href="File__setsys.f.html">setsys.f</a></li>
</ul><ul>
  <li><a href="File__setup.f.html">setup.f</a></li>
</ul><ul>
  <li><a href="File__short.f.html">short.f</a></li>
</ul><ul>
  <li><a href="File__shrink.f.html">shrink.f</a></li>
</ul><ul>
  <li><a href="File__slow.f.html">slow.f</a></li>
</ul><ul>
  <li><a href="File__sort1.f.html">sort1.f</a></li>
</ul><ul>
  <li><a href="File__sort3.f.html">sort3.f</a></li>
</ul><ul>
  <li><a href="File__stabl3.f.html">stabl3.f</a></li>
</ul><ul>
  <li><a href="File__stabl4.f.html">stabl4.f</a></li>
</ul><ul>
  <li><a href="File__stablc.f.html">stablc.f</a></li>
</ul><ul>
  <li><a href="File__stablz.f.html">stablz.f</a></li>
</ul><ul>
  <li><a href="File__star.f.html">star.f</a></li>
</ul><ul>
  <li><a href="File__start.F.html">start.F</a></li>
</ul><ul>
  <li><a href="File__start3.f.html">start3.f</a></li>
</ul><ul>
  <li><a href="File__start4.f.html">start4.f</a></li>
</ul><ul>
  <li><a href="File__status.f.html">status.f</a></li>
</ul><ul>
  <li><a href="File__stepi.f.html">stepi.f</a></li>
</ul><ul>
  <li><a href="File__stepk.f.html">stepk.f</a></li>
</ul><ul>
  <li><a href="File__steps.f.html">steps.f</a></li>
</ul><ul>
  <li><a href="File__stumpf.f.html">stumpf.f</a></li>
</ul><ul>
  <li><a href="File__subint.f.html">subint.f</a></li>
</ul><ul>
  <li><a href="File__subsys.f.html">subsys.f</a></li>
</ul><ul>
  <li><a href="File__swcond.f.html">swcond.f</a></li>
</ul><ul>
  <li><a href="File__switch.f.html">switch.f</a></li>
</ul><ul>
  <li><a href="File__tchain.f.html">tchain.f</a></li>
</ul><ul>
  <li><a href="File__tcirc.f.html">tcirc.f</a></li>
</ul><ul>
  <li><a href="File__tides.f.html">tides.f</a></li>
</ul><ul>
  <li><a href="File__tperi.f.html">tperi.f</a></li>
</ul><ul>
  <li><a href="File__tpert.f.html">tpert.f</a></li>
</ul><ul>
  <li><a href="File__trans3.f.html">trans3.f</a></li>
</ul><ul>
  <li><a href="File__trans4.f.html">trans4.f</a></li>
</ul><ul>
  <li><a href="File__transk.f.html">transk.f</a></li>
</ul><ul>
  <li><a href="File__transq.f.html">transq.f</a></li>
</ul><ul>
  <li><a href="File__transx.f.html">transx.f</a></li>
</ul><ul>
  <li><a href="File__triple.f.html">triple.f</a></li>
</ul><ul>
  <li><a href="File__tstep.f.html">tstep.f</a></li>
</ul><ul>
  <li><a href="File__units.f.html">units.f</a></li>
</ul><ul>
  <li><a href="File__unpert.f.html">unpert.f</a></li>
</ul><ul>
  <li><a href="File__update.f.html">update.f</a></li>
</ul><ul>
  <li><a href="File__vector.f.html">vector.f</a></li>
</ul><ul>
  <li><a href="File__verify.f.html">verify.f</a></li>
</ul><ul>
  <li><a href="File__xcpred.f.html">xcpred.f</a></li>
</ul><ul>
  <li><a href="File__xtf.f.html">xtf.f</a></li>
</ul><ul>
  <li><a href="File__xtpert.f.html">xtpert.f</a></li>
</ul><ul>
  <li><a href="File__xtrnl0.f.html">xtrnl0.f</a></li>
</ul><ul>
  <li><a href="File__xtrnld.f.html">xtrnld.f</a></li>
</ul><ul>
  <li><a href="File__xtrnlf.f.html">xtrnlf.f</a></li>
</ul><ul>
  <li><a href="File__xtrnlp.f.html">xtrnlp.f</a></li>
</ul><ul>
  <li><a href="File__xtrnlu.f.html">xtrnlu.f</a></li>
</ul><ul>
  <li><a href="File__xtrnlv.f.html">xtrnlv.f</a></li>
</ul><ul>
  <li><a href="File__xvpred.f.html">xvpred.f</a></li>
</ul><ul>
  <li><a href="File__ycopy.f.html">ycopy.f</a></li>
</ul><ul>
  <li><a href="File__ysave.f.html">ysave.f</a></li>
</ul><ul>
  <li><a href="File__zare.f.html">zare.f</a></li>
</ul><ul>
  <li><a href="File__zcnsts.f.html">zcnsts.f</a></li>
</ul><ul>
  <li><a href="File__zdata.f.html">zdata.f</a></li>
</ul><ul>
  <li><a href="File__zero.f.html">zero.f</a></li>
</ul><ul>
  <li><a href="File__zfuncs.f.html">zfuncs.f</a></li>
</ul>
</td>
          <td width="90%" valign="top">
            <h2><b>subroutine</b>:<i>REGINT</i></h2><br>
            <h3>      SUBROUTINE REGINT(I,KLIST)
</h3>
            Author:<i></i><br>
            Version:<i></i><br>
            <p>Belongs to: <a href="File__regint.f.html">regint.f</a></p>
            <p>Located at: <a href="File__regint.f.html">regint.f</a></p>
            <div>Uses:
              <ul>
                <li><a href="subroutine__CHECKL.html">CHECKL</a> at <a href="File__checkl.f.html">checkl.f</a></li>
              </ul><ul>
                <li><a href="subroutine__CHFIRR.html">CHFIRR</a> at <a href="File__chfirr.f.html">chfirr.f</a></li>
              </ul><ul>
                <li><a href="subroutine__CMFREG.html">CMFREG</a> at <a href="File__cmfreg.f.html">cmfreg.f</a></li>
              </ul><ul>
                <li><a href="subroutine__CPUTIM.html">CPUTIM</a> at <a href="File__cputim.F.html">cputim.F</a></li>
              </ul><ul>
                <li><a href="subroutine__FCHAIN.html">FCHAIN</a> at <a href="File__fchain.f.html">fchain.f</a></li>
              </ul><ul>
                <li><a href="subroutine__FCLOUD.html">FCLOUD</a> at <a href="File__fcloud.f.html">fcloud.f</a></li>
              </ul><ul>
                <li><a href="subroutine__FPCORR.html">FPCORR</a> at <a href="File__fpcorr.f.html">fpcorr.f</a></li>
              </ul><ul>
                <li><a href="subroutine__XTRNLF.html">XTRNLF</a> at <a href="File__xtrnlf.f.html">xtrnlf.f</a></li>
              </ul>
            </div>
            <div>Used by:
              <ul>
                <li><a href="subroutine__INTGRT.html">INTGRT</a> at <a href="File__intgrt.F.html">intgrt.F</a></li>
              </ul>
            </div>
            <tt>
<br>       Regular integration.
<br>       --------------------
<br>
</tt>
            
            <h3>Variables</h3>
            <table border="1">
              <tr><td> W0(4)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> W1(4)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> W2(4)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> W3(4)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> XI(3)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> XIDOT(3)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> FIRR(3)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> FREG(3)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> DV(3)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> FD(3)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> FDR(3)</td><td>REAL*8</td><td></td><td></td></tr><tr><td> ESCFLG(NMAX)</td><td>INTEGER</td><td></td><td></td></tr><tr><td> KLIST(LMAX)</td><td>INTEGER</td><td></td><td></td></tr>
            </table>
            <pre class="source">      <span class="kw">SUBROUTINE</span> <a href="subroutine__REGINT.html">REGINT</a>(I,KLIST)
<span class="comm">*
</span><span class="comm">*       Regular integration.
</span><span class="comm">*       --------------------
</span><span class="comm">*
</span>      <span class="kw">INCLUDE</span> <span class="str">'common6.h'</span>
      <span class="kw">COMMON</span>/CHAINC/  XC(3,NCMAX),UC(3,NCMAX),BODYC(NCMAX),ICH,
                LISTC(LMAX)
<span class="comm">*       Calculate potential with little extra cost.
</span>      <span class="kw">COMMON</span>/POTENT/PHII(NMAX),PHIR(NMAX),PHIR1(NMAX)
      <span class="dtype">REAL</span>*8  W0(4),W1(4),W2(4),W3(4)
      <span class="dtype">REAL</span>*8  XI(3),XIDOT(3),FIRR(3),FREG(3),DV(3),FD(3),FDR(3)
      <span class="dtype">INTEGER</span> ESCFLG(NMAX)
<span class="comm">*
</span>      <span class="dtype">INTEGER</span> KLIST(LMAX)
<span class="comm">*
</span>      <span class="kw">DO</span> 6 K = 1,3
          XI(K) = X(K,I)
          XIDOT(K) = XDOT(K,I)
   6  <span class="kw">CONTINUE</span>
<span class="comm">*
</span><span class="comm">*       Copy uncorrected X and set time-step & central distance.
</span>      NNB0 = KLIST(1)
      DTR = TIME - T0R(I)
      IRSKIP = 0
      RI2 = (XI(1) - RDENS(1))**2 + (XI(2) - RDENS(2))**2 +
                              (XI(3) - RDENS(3))**2
      RH2 = RSCALE**2
<span class="comm">*
</span><span class="comm">*       Obtain irregular & regular force and determine current neighbours.
</span>      RS2 = RS(I)**2
<span class="comm">*       Take volume between inner and outer radius equal to basic sphere.
</span>    1 RCRIT2 = 1.59*RS2
<span class="comm">*       Set radial velocity factor for the outer shell.
</span>      VRFAC = -0.1*RS2/DTR
<span class="comm">*       Start count at 2 and subtract 1 at the end to avoid ILIST(NNB+1).
</span>      NNB = 1
<span class="comm">*
</span><span class="comm">*       Initialize scalars for forces & derivatives.
</span>      <span class="kw">DO</span> 5 K = 1,3
          FIRR(K) = 0.0D0
          FREG(K) = 0.0D0
          FD(K) = 0.0
          FDR(K) = 0.0
    5 <span class="kw">CONTINUE</span>
      PHII(I) = 0.D0
      PHIR(I) = 0.D0
      PHIR1(I) = 0.D0
<span class="comm">*
</span><span class="comm">*       Choose appropriate force loop for single particle or c.m. body.
</span>      <span class="kw">IF</span> (I.GT.N) <span class="kw">THEN</span>
<span class="comm">*       See whether perturbation allows single particle approximation.
</span>          <span class="kw">IF</span> (GAMMA(I-N).GE.GMIN) <span class="kw">THEN</span>
<span class="comm">*       Obtain total force on c.m. particle.
</span>           <span class="kw">CALL</span> <a href="subroutine__CMFREG.html">CMFREG</a>(I,RS2,RCRIT2,VRFAC,NNB,XI,XIDOT,FIRR,FREG,FD,FDR)
           GO TO 20
          <span class="kw">END</span> <span class="kw">IF</span>
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Perform fast force loop over single particles.
</span>          <span class="kw">call</span> <a href="subroutine__CPUTIM.html">cputim</a>(tt1)
      <span class="kw">DO</span> 10 J = IFIRST,N
<span class="comm">*RSP
</span>          <span class="kw">IF</span> (J.EQ.I) GO TO 10
<span class="comm">*RSP
</span>          A1 = X(1,J) - XI(1)
          A2 = X(2,J) - XI(2)
          A3 = X(3,J) - XI(3)
<span class="comm">*       Predicted coordinates avoids spurious force differences.
</span>          DV(1) = XDOT(1,J) - XIDOT(1)
          DV(2) = XDOT(2,J) - XIDOT(2)
          DV(3) = XDOT(3,J) - XIDOT(3)
<span class="comm">*
</span>          RIJ2 = A1*A1 + A2*A2 + A3*A3
          DR2I = 1.0/RIJ2
          DR3I = BODY(J)*DR2I*SQRT(DR2I)
          DRDV = A1*DV(1) + A2*DV(2) + A3*DV(3)
          DRDP = 3.0*DRDV*DR2I
<span class="comm">*
</span><span class="comm">*       See whether the distance exceeds the outer shell radius.
</span>          <span class="kw">IF</span> (RIJ2.GT.RCRIT2) GO TO 8
<span class="comm">*
</span><span class="comm">*       Retain particles with small steps (large derivative corrections).
</span>          <span class="kw">IF</span> (RIJ2.GT.RS2.AND.STEP(J).GT.10.0*SMIN) <span class="kw">THEN</span>
<span class="comm">*       Accept member if maximum penetration factor exceeds 8 per cent.
</span>              <span class="kw">IF</span> (DRDV.GT.VRFAC) GO TO 8
          <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Increase neighbour counter and obtain current irregular force.
</span>          NNB = NNB + 1
          ILIST(NNB) = J
          FIRR(1) = FIRR(1) + A1*DR3I
          FIRR(2) = FIRR(2) + A2*DR3I
          FIRR(3) = FIRR(3) + A3*DR3I
          FD(1) = FD(1) + (DV(1) - A1*DRDP)*DR3I
          FD(2) = FD(2) + (DV(2) - A2*DRDP)*DR3I
          FD(3) = FD(3) + (DV(3) - A3*DRDP)*DR3I
<span class="comm">*       Obtain potential.
</span>          PHII(I) = PHII(I) - DR3I*RIJ2
          GO TO 10
<span class="comm">*
</span><span class="comm">*       Obtain the regular force.
</span>    8     FREG(1) = FREG(1) + A1*DR3I
          FREG(2) = FREG(2) + A2*DR3I
          FREG(3) = FREG(3) + A3*DR3I
          FDR(1) = FDR(1) + (DV(1) - A1*DRDP)*DR3I
          FDR(2) = FDR(2) + (DV(2) - A2*DRDP)*DR3I
          FDR(3) = FDR(3) + (DV(3) - A3*DRDP)*DR3I
<span class="comm">*       Obtain potential and derivative.
</span>          PHIR(I) = PHIR(I) - DR3I*RIJ2
          PHIR1(I) = PHIR1(I) + DRDV*DR3I
   10 <span class="kw">CONTINUE</span>
          <span class="kw">call</span> <a href="subroutine__CPUTIM.html">cputim</a>(tt2)
          ttfrc = ttfrc + (tt2-tt1)*60.
<span class="comm">*
</span><span class="comm">*       Check total energy
</span>          VI2 = XIDOT(1)**2 + XIDOT(2)**2 + XIDOT(3)**2
          EI = VI2/2.D0 + PHIR(I) + PHII(I)
          ETIDAL = -ZMASS/RTIDE
          <span class="kw">IF</span>(EI.GT.ETIDAL)<span class="kw">THEN</span>
              <span class="kw">IF</span>(ESCFLG(NAME(I)).NE.1)
        WRITE(95,1001) TIME,I,NAME(I),BODY(I),DSQRT(RI2),
                       DSQRT(VI2),EI,ETIDAL
              ESCFLG(NAME(I)) = 1
 1001     <span class="kw">FORMAT</span>(1X,<span class="str">' T='</span>,1P,D15.7,<span class="str">' I,N='</span>,2I6,<span class="str">' m,r,v='</span>,3D15.7,
        <span class="str">' e,et='</span>,2D15.7)
          <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*       Add any contributions from regularized c.m. particles.
</span>      <span class="kw">IF</span> (NPAIRS.GT.0) <span class="kw">THEN</span>
          <span class="kw">CALL</span> <a href="subroutine__CMFREG.html">CMFREG</a>(I,RS2,RCRIT2,VRFAC,NNB,XI,XIDOT,FIRR,FREG,FD,FDR)
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Include treatment for regularized clump.
</span>      <span class="kw">IF</span> (NCH.GT.0) <span class="kw">THEN</span>
<span class="comm">*       Distinguish between chain c.m. and any other particle.
</span>          <span class="kw">IF</span> (NAME(I).EQ.0) <span class="kw">THEN</span>
              <span class="kw">CALL</span> <a href="subroutine__CHFIRR.html">CHFIRR</a>(I,1,XI,XIDOT,FIRR,FD)
          <span class="kw">ELSE</span>
<span class="comm">*       Search the chain perturber list for #I.
</span>              <span class="kw">DO</span> 15 L = 2,NNB
                  J = ILIST(L)
                  <span class="kw">IF</span> (J.GT.ICH) GO TO 20
                  <span class="kw">IF</span> (J.EQ.ICH) <span class="kw">CALL</span> <a href="subroutine__FCHAIN.html">FCHAIN</a>(I,1,XI,XIDOT,FIRR,FD)
   15         <span class="kw">CONTINUE</span>
          <span class="kw">END</span> <span class="kw">IF</span>
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       See whether an external force should be added.
</span>   20 <span class="kw">CONTINUE</span>
<span class="comm">*
</span>      <span class="kw">IF</span> (KZ(14).GT.0) <span class="kw">THEN</span>
          <span class="kw">CALL</span> <a href="subroutine__XTRNLF.html">XTRNLF</a>(I,XI,XIDOT,FIRR,FREG,FD,FDR,1)
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Check whether cloud forces should be included.
</span>      <span class="kw">IF</span> (KZ(13).GT.0) <span class="kw">THEN</span>
          <span class="kw">CALL</span> <a href="subroutine__FCLOUD.html">FCLOUD</a>(I,FREG,FDR,1)
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span>      NNB = NNB - 1
<span class="comm">*       Check for zero neighbour number or distant particle with large STEP.
</span>      <span class="kw">IF</span> (NNB.EQ.0.OR.(RI2.GT.100.0*RH2.AND.
    STEP(I).GT.200.0*DTMIN)) <span class="kw">THEN</span>
<span class="comm">*       Double the neighbour sphere and try again unless RI > 30*RSCALE.
</span>          <span class="kw">IF</span> (RI2.GT.100.0*RH2.OR.KLIST(1).EQ.0) <span class="kw">THEN</span>
              IRSKIP = 1
<span class="comm">*       Assume small mass at centre for distant body or no neighbours.
</span>              R2 = XI(1)**2 + XI(2)**2 + XI(3)**2
              FIJ = 0.01*BODYM/(R2*SQRT(R2))
              RDOT = 3.0*(XI(1)*XIDOT(1) + XI(2)*XIDOT(2) +
                                     XI(3)*XIDOT(3))/R2
              <span class="kw">DO</span> 25 K = 1,3
                  FIRR(K) = FIRR(K) - FIJ*XI(K)
                  FD(K) = FD(K) - (XIDOT(K) - RDOT*XI(K))*FIJ
   25         <span class="kw">CONTINUE</span>
<span class="comm">*       Check maximum membership (note: NNB may be large).
</span>              <span class="kw">IF</span> (NNB.GT.NNBMAX) <span class="kw">THEN</span>
                  RS2 = 0.9*RS2
                  GO TO 1
              <span class="kw">ELSE</span>
<span class="comm">*       Specify zero members and reduce neighbour sphere gradually (but > 0).
</span>                  KLIST(1) = 0
                  RS(I) = MAX(0.75*RS(I),0.01*RSCALE)
                  GO TO 50
              <span class="kw">END</span> <span class="kw">IF</span>
          <span class="kw">ELSE</span>
              RS2 = 1.59*RS2
          <span class="kw">END</span> <span class="kw">IF</span>
          RS(I) = SQRT(RS2)
          NBVOID = NBVOID + 1
          <span class="kw">IF</span> (RS(I).GT.10.0*RSCALE) IRSKIP = 1
          GO TO 1
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Restrict neighbour number < NNBMAX to permit one normal addition.
</span>      <span class="kw">IF</span> (NNB.LT.NNBMAX) GO TO 40
<span class="comm">*
</span><span class="comm">*       Reduce search radius by cube root of conservative volume factor.
</span>   30 NNB2 = 0.8*NNBMAX
      A1 = FLOAT(NNB2)/FLOAT(NNB)
      <span class="kw">IF</span> (RS(I).GT.5.0*RSCALE) <span class="kw">THEN</span>
          A1 = MIN(5.0*A1,0.9D0)
          IRSKIP = 1
      <span class="kw">END</span> <span class="kw">IF</span>
      RS2 = RS2*A1**0.66667
      RCRIT2 = 1.59*RS2
      RS(I) = SQRT(RS2)
      NNB1 = 0
<span class="comm">*
</span>      <span class="kw">DO</span> 35 L = 1,NNB
          J = ILIST(L+1)
          <span class="kw">IF</span> (L + NNB2.GT.NNB + NNB1) GO TO 32
<span class="comm">*       Sum of neighbours (NNB1) & those left (NNB+1-L) set to NNB2.
</span>          A1 = X(1,J) - XI(1)
          A2 = X(2,J) - XI(2)
          A3 = X(3,J) - XI(3)
          DV(1) = XDOT(1,J) - XIDOT(1)
          DV(2) = XDOT(2,J) - XIDOT(2)
          DV(3) = XDOT(3,J) - XIDOT(3)
<span class="comm">*
</span>          RIJ2 = A1*A1 + A2*A2 + A3*A3
          DR2I = 1.0/RIJ2
          DR3I = BODY(J)*DR2I*SQRT(DR2I)
          DRDV = A1*DV(1) + A2*DV(2) + A3*DV(3)
          DRDP = 3.0*DRDV*DR2I
          <span class="kw">IF</span> (RIJ2.GT.RCRIT2) GO TO 34
<span class="comm">*
</span>          <span class="kw">IF</span> (RIJ2.GT.RS2.AND.STEP(J).GT.SMIN) <span class="kw">THEN</span>
              <span class="kw">IF</span> (DRDV.GT.VRFAC.AND.J.LE.N) GO TO 34
<span class="comm">*       Retain any c.m. because of complications in force correction.
</span>          <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span>   32     NNB1 = NNB1 + 1
          JLIST(NNB1+1) = J
          GO TO 35
<span class="comm">*
</span><span class="comm">*       Subtract neighbour force included above and add to regular force.
</span>   34     FIRR(1) = FIRR(1) - A1*DR3I
          FIRR(2) = FIRR(2) - A2*DR3I
          FIRR(3) = FIRR(3) - A3*DR3I
          FD(1) = FD(1) - (DV(1) - A1*DRDP)*DR3I
          FD(2) = FD(2) - (DV(2) - A2*DRDP)*DR3I
          FD(3) = FD(3) - (DV(3) - A3*DRDP)*DR3I
          FREG(1) = FREG(1) + A1*DR3I
          FREG(2) = FREG(2) + A2*DR3I
          FREG(3) = FREG(3) + A3*DR3I
          FDR(1) = FDR(1) + (DV(1) - A1*DRDP)*DR3I
          FDR(2) = FDR(2) + (DV(2) - A2*DRDP)*DR3I
          FDR(3) = FDR(3) + (DV(3) - A3*DRDP)*DR3I
<span class="comm">*       Obtain potential and derivative.
</span>          PHII(I) = PHII(I) - DR3I*RIJ2
          PHIR(I) = PHIR(I) - DR3I*RIJ2
          PHIR1(I) = PHIR1(I) + DRDV*DR3I
   35 <span class="kw">CONTINUE</span>
<span class="comm">*
</span>      <span class="kw">DO</span> 38 L = 2,NNB1+1
          ILIST(L) = JLIST(L)
   38 <span class="kw">CONTINUE</span>
      NNB = NNB1
      NBFULL = NBFULL + 1
<span class="comm">*       See whether to reduce NNB further.
</span>      <span class="kw">IF</span> (NNB.GE.NNBMAX) GO TO 30
<span class="comm">*
</span><span class="comm">*       Stabilize NNB between ZNBMIN & ZNBMAX by square root of contrast.
</span><span class="comm">*       Include optional stabilization to increase neighbour number.
</span><span class="comm">*       Take input parameter NNBOPT as optimal neighbour number (R.Sp.)
</span><span class="comm">*       Note that it substitutes input parameter NNBMAX, which
</span><span class="comm">*       is now a parameter NNBMAX=LMAX-3
</span>   40 <span class="kw">CONTINUE</span>
<span class="comm">*
</span>      FAC = 1.D0
      <span class="kw">IF</span> (KZ(40).GT.0) <span class="kw">THEN</span>
          FAC = 1.0 + 0.1*(FLOAT(NNBOPT) - FLOAT(NNB))/FLOAT(NNB)
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*     A3 = ALPHA*FAC*SQRT(FLOAT(NNB)*RS(I))/RS2
</span>      A3 = FLOAT(NNB)*FAC
      A3 = MIN(A3,0.9*ZNBMAX)
<span class="comm">*       Reduce predicted membership slowly outside half-mass radius.
</span>      <span class="kw">IF</span> (RI2.GT.RH2) <span class="kw">THEN</span>
          A3 = A3*RSCALE/SQRT(RI2)
      <span class="kw">ELSE</span>
          A3 = MAX(A3,ZNBMIN)
      <span class="kw">END</span> <span class="kw">IF</span>
      A4 = A3/FLOAT(NNB)
<span class="comm">*
</span><span class="comm">*       Include inertial factor to prevent resonance oscillations in RS.
</span>      <span class="kw">IF</span> ((A3 - FLOAT(NNB0))*(A3 - FLOAT(NNB)).LT.0.0) A4 = SQRT(A4)
<span class="comm">*
</span><span class="comm">*       Modify volume ratio by radial velocity factor outside the core.
</span>      <span class="kw">IF</span> (RI2.GT.RC2.AND.RI2.LT.100.0*RH2) <span class="kw">THEN</span>
          RIDOT = (XI(1) - RDENS(1))*XIDOT(1) +
            (XI(2) - RDENS(2))*XIDOT(2) +
            (XI(3) - RDENS(3))*XIDOT(3)
          A4 = A4*(1.0 + RIDOT*DTR/RI2)
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       See whether neighbour radius of c.m. body should be increased.
</span>      <span class="kw">IF</span> (I.GT.N) <span class="kw">THEN</span>
<span class="comm">*       Set perturber range (soft binaries & H > 0 have short duration).
</span>          A2 = 100.0*BODY(I)/ABS(H(I-N))
<span class="comm">*       Stabilize NNB on ZNBMAX if too few perturbers.
</span>          <span class="kw">IF</span> (A2.GT.RS(I)) <span class="kw">THEN</span>
              A3 = MAX(1.0 - FLOAT(NNB)/ZNBMAX,0.0D0)
<span class="comm">*       Modify volume ratio by approximate square root factor.
</span>              A4 = 1.0 + 0.5*A3
          <span class="kw">END</span> <span class="kw">IF</span>
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Limit change of RS for small steps (RSFAC = MAX(25/TCR,1.5*VC/RSMIN).
</span>      A5 = MIN(RSFAC*DTR,0.25D0)
<span class="comm">*       Restrict volume ratio by inertial factor of 25 per cent either way.
</span>      A4 = A4 - 1.0
      <span class="kw">IF</span> (A4.GT.A5) <span class="kw">THEN</span>
          A4 = A5
      <span class="kw">ELSE</span>
          A4 = MAX(A4,-A5)
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Modify neighbour sphere radius by volume factor.
</span>      <span class="kw">IF</span> (IRSKIP.EQ.0) <span class="kw">THEN</span>
          A3 = ONE3*A4
          A1 = 1.0 + A3 - A3*A3
<span class="comm">*       Second-order cube root expansion (maximum volume error < 0.3 %).
</span>          <span class="kw">IF</span> (RS(I).GT.5.0*RSCALE) A1 = SQRT(A1)
<span class="comm">*       Skip modification for small changes (avoids oscillations in RS).
</span>          <span class="kw">IF</span> (ABS(A1 - 1.0D0).GT.0.003) <span class="kw">THEN</span>
              RS(I) = A1*RS(I)
          <span class="kw">END</span> <span class="kw">IF</span>
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Calculate the radial velocity with respect to at most 3 neighbours.
</span>      <span class="kw">IF</span> (NNB.LE.3.AND.RI2.LT.100.0*RH2) <span class="kw">THEN</span>
          A1 = 2.0*RS(I)
<span class="comm">*
</span>          <span class="kw">DO</span> 45 L = 1,NNB
              J = ILIST(L+1)
              RIJ = SQRT((XI(1) - X(1,J))**2 + (XI(2) - X(2,J))**2 +
                                         (XI(3) - X(3,J))**2)
              RSDOT = ((XI(1) - X(1,J))*(XIDOT(1) - XDOT(1,J)) +
                 (XI(2) - X(2,J))*(XIDOT(2) - XDOT(2,J)) +
                 (XI(3) - X(3,J))*(XIDOT(3) - XDOT(3,J)))/RIJ
<span class="comm">*       Find smallest neighbour distance assuming constant regular step.
</span>              A1 = MIN(A1,RIJ + RSDOT*DTR)
   45     <span class="kw">CONTINUE</span>
<span class="comm">*
</span><span class="comm">*       Increase neighbour sphere if all members are leaving inner region.
</span>          RS(I) = MAX(A1,1.1*RS(I))
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Check optional procedures for adding neighbours.
</span>      <span class="kw">IF</span> (KZ(18).EQ.0) GO TO 50
      <span class="kw">IF</span> (KZ(18).EQ.1.AND.LISTV(1).EQ.0) GO TO 50
      <span class="kw">CALL</span> <a href="subroutine__CHECKL.html">CHECKL</a>(I,NNB,XI,XIDOT,RS2,FIRR,FREG,FD,FDR)
<span class="comm">*
</span><span class="comm">*       Find loss or gain of neighbours at the same time.
</span>   50 NBLOSS = 0
      NBGAIN = 0
<span class="comm">*
</span><span class="comm">*       Check case of zero old or new membership (skip if both are zero).
</span>      <span class="kw">IF</span> (NNB0.EQ.0) <span class="kw">THEN</span>
          <span class="kw">IF</span> (NNB.EQ.0) GO TO 70
          KLIST(2) = 0
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span>      JMIN = 0
      L = 2
      LG = 2
<span class="comm">*       Set termination value in ILIST(NNB+2) and save last list member.
</span>      ILIST(NNB+2) = NTOT + 1
      ILIST(1) = KLIST(NNB0+1)
<span class="comm">*
</span><span class="comm">*       Compare old and new list members in locations L & LG.
</span>   56 <span class="kw">IF</span> (KLIST(L).EQ.ILIST(LG)) GO TO 58
<span class="comm">*
</span><span class="comm">*       Now check whether inequality means gain or loss.
</span>      <span class="kw">IF</span> (KLIST(L).GE.ILIST(LG)) <span class="kw">THEN</span>
          NBGAIN = NBGAIN + 1
          JLIST(NNB0+NBGAIN) = ILIST(LG)
<span class="comm">*       Number of neighbour losses can at most be NNB0.
</span>          L = L - 1
<span class="comm">*       The same location will be searched again after increasing L below.
</span>      <span class="kw">ELSE</span>
          NBLOSS = NBLOSS + 1
          J = KLIST(L)
          JLIST(NBLOSS) = J
<span class="comm">*       Check SMIN step indicator (rare case permits fast skip below).
</span>          <span class="kw">IF</span> (STEP(J).LT.SMIN) JMIN = J
          LG = LG - 1
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       See whether the last location has been checked.
</span>   58 <span class="kw">IF</span> (L.LE.NNB0) <span class="kw">THEN</span>
          L = L + 1
          LG = LG + 1
<span class="comm">*       Last value of second search index is NNB + 2 which holds NTOT + 1.
</span>          GO TO 56
      <span class="kw">ELSE</span> <span class="kw">IF</span> (LG.LE.NNB) <span class="kw">THEN</span>
          LG = LG + 1
          KLIST(L) = NTOT + 1
<span class="comm">*       Last location of list holds termination value (saved in ILIST(1)).
</span>          GO TO 56
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       See whether any old neighbour with small step should be retained.
</span>      <span class="kw">IF</span> (JMIN.EQ.0) GO TO 70
<span class="comm">*
</span>      K = 1
   60 <span class="kw">IF</span> (NNB.GT.NNBMAX.OR.I.GT.N) GO TO 70
      J = JLIST(K)
<span class="comm">*       A single regularized component will be replaced by the c.m.
</span>      <span class="kw">IF</span> (STEP(J).GT.SMIN.OR.J.LT.IFIRST.OR.J.GT.N) GO TO 68
<span class="comm">*       Retain old neighbour inside 2*RS to avoid large correction terms.
</span>      RIJ2 = (XI(1) - X(1,J))**2 + (XI(2) - X(2,J))**2 +
                             (XI(3) - X(3,J))**2
      <span class="kw">IF</span> (RIJ2.GT.4.0*RS2) GO TO 68
<span class="comm">*
</span>      L = NNB + 1
   62 <span class="kw">IF</span> (ILIST(L).LT.J) GO TO 64
      ILIST(L+1) = ILIST(L)
      L = L - 1
      <span class="kw">IF</span> (L.GT.1) GO TO 62
<span class="comm">*
</span><span class="comm">*       Save index of body #J and update NNB & NBLOSS.
</span>   64 ILIST(L+1) = J
      NNB = NNB + 1
      NBLOSS = NBLOSS - 1
<span class="comm">*       Restore last old neighbour in case NBLOSS = 0 at end of search.
</span>      KLIST(NNB0+1) = ILIST(1)
      NBSMIN = NBSMIN + 1
<span class="comm">*
</span><span class="comm">*       Perform correction to irregular and regular force components.
</span>      A1 = X(1,J) - XI(1)
      A2 = X(2,J) - XI(2)
      A3 = X(3,J) - XI(3)
      DV(1) = XDOT(1,J) - XIDOT(1)
      DV(2) = XDOT(2,J) - XIDOT(2)
      DV(3) = XDOT(3,J) - XIDOT(3)
<span class="comm">*
</span>      RIJ2 = A1*A1 + A2*A2 + A3*A3
      DR2I = 1.0/RIJ2
      DR3I = BODY(J)*DR2I*SQRT(DR2I)
      DRDV = A1*DV(1) + A2*DV(2) + A3*DV(3)
      DRDP = 3.0*DRDV*DR2I
<span class="comm">*
</span>      FIRR(1) = FIRR(1) + A1*DR3I
      FIRR(2) = FIRR(2) + A2*DR3I
      FIRR(3) = FIRR(3) + A3*DR3I
      FD(1) = FD(1) + (DV(1) - A1*DRDP)*DR3I
      FD(2) = FD(2) + (DV(2) - A2*DRDP)*DR3I
      FD(3) = FD(3) + (DV(3) - A3*DRDP)*DR3I
      FREG(1) = FREG(1) - A1*DR3I
      FREG(2) = FREG(2) - A2*DR3I
      FREG(3) = FREG(3) - A3*DR3I
      FDR(1) = FDR(1) - (DV(1) - A1*DRDP)*DR3I
      FDR(2) = FDR(2) - (DV(2) - A2*DRDP)*DR3I
      FDR(3) = FDR(3) - (DV(3) - A3*DRDP)*DR3I
<span class="comm">*       Obtain potential and derivative.
</span>      PHII(I) = PHII(I) - DR3I*RIJ2
      PHIR(I) = PHIR(I) - DR3I*RIJ2
      PHIR1(I) = PHIR1(I) + DRDV*DR3I
<span class="comm">*
</span><span class="comm">*       Remove body #J from JLIST unless it is the last or only member.
</span>      <span class="kw">IF</span> (K.GT.NBLOSS) GO TO 70
      <span class="kw">DO</span> 66 L = K,NBLOSS
          JLIST(L) = JLIST(L+1)
   66 <span class="kw">CONTINUE</span>
<span class="comm">*       Index of last body to be moved up is L = NBLOSS + 1.
</span>      K = K - 1
<span class="comm">*       Check the same location again since a new body has appeared.
</span>   68 K = K + 1
<span class="comm">*       Last member to be considered is in location K = NBLOSS.
</span>      <span class="kw">IF</span> (K.LE.NBLOSS) GO TO 60
<span class="comm">*
</span><span class="comm">*       Form time-step factors and update regular force time.
</span>   70 <span class="kw">CONTINUE</span>
<span class="comm">*
</span>      DTSQ = DTR**2
      DT6 = 6.0/(DTR*DTSQ)
      DT2 = 2.0/DTSQ
      DTSQ12 = ONE12*DTSQ
      DTR13 = ONE3*DTR
      T0R(I) = TIME
<span class="comm">*
</span><span class="comm">*       Suppress the corrector for large time-step ratios (experimental).
</span>      <span class="kw">IF</span> (DTR.GT.50.0*STEP(I)) <span class="kw">THEN</span>
          DTR13 = 0.0
          DTSQ12 = 0.0
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Include the corrector and save F, FI, FR & polynomial derivatives.
</span>      <span class="kw">DO</span> 75 K = 1,3
<span class="comm">*       Subtract change of neighbour force to form actual first derivative.
</span>          DFR = FR(K,I) - (FIRR(K) - FI(K,I)) - FREG(K)
          FDR0 = FDR(K) - (FIDOT(K,I) - FD(K))
<span class="comm">*
</span>          FRD = FRDOT(K,I)
 = FRD + FDR0
 = 2.0*DFR + DTR*SUM
 = -3.0*DFR - DTR*(SUM + FRD)
<span class="comm">*       Use here new variables for consistency in parallel execution (R.Sp.)
</span>          XN(K,I) = X0(K,I) + (0.6*AT3 + BT2)*DTSQ12
          XNDOT(K,I) = X0DOT(K,I) + (0.75*AT3 + BT2)*DTR13
<span class="comm">*
</span>          FI(K,I) = FIRR(K)
          FR(K,I) = FREG(K)
          FIDOT(K,I) = FD(K)
          FRDOT(K,I) = FDR(K)
<span class="comm">*
</span>          D0(K,I) = FIRR(K)
          D0R(K,I) = FREG(K)
          D1R(K,I) = FDR(K)
          D3R(K,I) = AT3*DT6
          D2R(K,I) = (3.0*AT3 + BT2)*DT2
   75 <span class="kw">CONTINUE</span>
<span class="comm">*
</span>      NBFLUX = NBFLUX + NBLOSS + NBGAIN
<span class="comm">*       Correct force polynomials due to neighbour changes (KZ(38) or I > N).
</span>      <span class="kw">IF</span> (KZ(38).GT.0) <span class="kw">THEN</span>
          <span class="kw">CALL</span> <a href="subroutine__FPCORR.html">FPCORR</a>(I,NBLOSS,NBGAIN,XI,XIDOT,FIRR,FREG,FD,FDR,KLIST)
      <span class="kw">ELSE</span> <span class="kw">IF</span> (I.GT.N) <span class="kw">THEN</span>
          <span class="kw">IF</span> (GAMMA(I-N).GT.GMAX) <span class="kw">THEN</span>
          <span class="kw">CALL</span> <a href="subroutine__FPCORR.html">FPCORR</a>(I,NBLOSS,NBGAIN,XI,XIDOT,FIRR,FREG,FD,FDR,KLIST)
          <span class="kw">END</span> <span class="kw">IF</span>
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Copy new neighbour list if different from old list.
</span>      <span class="kw">IF</span> (NBLOSS + NBGAIN.GT.0) <span class="kw">THEN</span>
          KLIST(1) = NNB
          <span class="kw">DO</span> 80 L = 2,NNB+1
              KLIST(L) = ILIST(L)
   80     <span class="kw">CONTINUE</span>
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Check for boundary reflection (RI2 < 0 denotes new polynomials set).
</span><span class="comm">*     IF (KZ(29).GT.0.AND.RI2.GT.RS2) THEN
</span><span class="comm">*         CALL REFLCT(I,RI2)
</span><span class="comm">*         IF (RI2.LT.0.0) GO TO 120
</span><span class="comm">*     END IF
</span><span class="comm">*
</span><span class="comm">*       Obtain new regular integration step using composite expression.
</span><span class="comm">*       STEPR = (ETAR*(F*F2DOT + FDOT**2)/(FDOT*F3DOT + F2DOT**2))**0.5.
</span>      <span class="kw">DO</span> 100 K = 1,3
          W1(K) = FDR(K)
          W2(K) = D2R(K,I)
          W3(K) = D3R(K,I)
  100 <span class="kw">CONTINUE</span>
<span class="comm">*
</span>      W0(4) = FREG(1)**2 + FREG(2)**2 + FREG(3)**2
      W1(4) = W1(1)**2 + W1(2)**2 + W1(3)**2
      W2(4) = W2(1)**2 + W2(2)**2 + W2(3)**2
      W3(4) = W3(1)**2 + W3(2)**2 + W3(3)**2
<span class="comm">*
</span><span class="comm">*       Form new step by relative criterion (extra SQRT for large F3DOT).
</span>      <span class="kw">IF</span> (W3(4).LT.1.0E+20) <span class="kw">THEN</span>
          W0(1) = (SQRT(W0(4)*W2(4)) + W1(4))/
                                       (SQRT(W1(4)*W3(4)) + W2(4))
      <span class="kw">ELSE</span>
          W0(1) = (SQRT(W0(4)*W2(4)) + W1(4))/
                                 (SQRT(W1(4))*SQRT(W3(4)) + W2(4))
      <span class="kw">END</span> <span class="kw">IF</span>
      W0(1) = ETAR*W0(1)
      TTMP = SQRT(W0(1))
<span class="comm">*       Winston Sweatman's suggestion
</span><span class="comm">*     DVV = (XDOT(1,I)-X0DOT(1,I))**2 + (XDOT(2,I)-X0DOT(2,I))**2 +
</span><span class="comm">*    &     (XDOT(3,I)-X0DOT(3,I))**2
</span><span class="comm">*     FFD = FREG(1)**2 + FREG(2)**2 + FREG(3)**2
</span><span class="comm">*     ETARW = ETAR
</span><span class="comm">*     TTMPW = ETARW*DVV*BODY(I)/FFD
</span><span class="comm">*
</span><span class="comm">*     PRINT*,' Reg I=',I,' TTMP,TTMPW,RATIO=',
</span><span class="comm">*    &  TTMP,TTMPW,TTMP/TTMPW
</span><span class="comm">*
</span><span class="comm">*     IF(TTMP.GT.TTMPW)THEN
</span><span class="comm">*     IGT = IGT + 1
</span><span class="comm">*     ELSE
</span><span class="comm">*     ILE = ILE + 1
</span><span class="comm">*     END IF
</span><span class="comm">*     IF(MOD(IGT+ILE,100).EQ.0)PRINT*,' irr IGT,ILE=',IGT,ILE
</span><span class="comm">*
</span><span class="comm">*     TTMP = MAX(TTMPW,TTMP)
</span><span class="comm">*     TTR = TSTEP(FREG,FDR,D2R(1,I),D3R(1,I),ETAR)
</span><span class="comm">*
</span><span class="comm">*       Adopt FAC*MIN(FREG,FIRR) (or tidal force) for convergence test.
</span>      FAC = MIN(ETAR,0.04D0)
      <span class="kw">IF</span> (TIDAL(1).EQ.0.0D0) <span class="kw">THEN</span>
          FI2 = FIRR(1)**2 + FIRR(2)**2 + FIRR(3)**2
          W0(4) = FAC**2*MIN(DBLE(W0(4)),FI2)
      <span class="kw">ELSE</span>
          W0(1) = (TIDAL(1)*XI(1))**2
          W0(4) = FAC**2*MAX(W0(4),W0(1))
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Obtain regular force change using twice the predicted step.
</span>      DTC = 2.0*TTMP
      S2 = 0.5*DTC
      S3 = ONE3*DTC
      W0(1) = 0.0
      <span class="kw">DO</span> 105 K = 1,3
          W0(2) = ((W3(K)*S3 + W2(K))*S2 + W1(K))*DTC
          W0(1) = W0(1) + W0(2)**2
  105 <span class="kw">CONTINUE</span>
<span class="comm">*
</span><span class="comm">*       See whether regular step can be increased by factor 2.
</span>      <span class="kw">IF</span> (W0(1).LT.W0(4)) <span class="kw">THEN</span>
          TTMP = DTC
          NRCONV = NRCONV + 1
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Impose a smooth step reduction inside compact core.
</span>      <span class="kw">IF</span> (NC.LT.50.AND.RI2.LT.RC2) <span class="kw">THEN</span>
          TTMP = TTMP*MIN(1.0D0,0.5D0*(1.0D0 + RI2*RC2IN))
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Select discrete value (increased by 2, decreased by 2 or unchanged).
TTMP .GT. 2.0*STEPR(I)) THEN
</span>			<span class="kw">IF</span> (DMOD(TIME,2.0*STEPR(I)) .EQ. 0.0D0) <span class="kw">THEN</span>
              TTMP = MIN(2.0*STEPR(I),1.D0)
          <span class="kw">ELSE</span>
              TTMP = STEPR(I)
          <span class="kw">END</span> <span class="kw">IF</span>
      <span class="kw">ELSE</span> <span class="kw">IF</span> (TTMP .LT. STEPR(I)) <span class="kw">THEN</span>
          TTMP = 0.5*STEPR(I)
      <span class="kw">ELSE</span>
          TTMP = STEPR(I)
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span><span class="comm">*       Set new regular step and reduce irregular step if STEPR < STEP.
</span><span class="comm">*     PRINT*,' New Step = ',TTMP,' Old ',STEPR(I),' Quot ',TTMP/STEPR(I)
</span>      STEPR(I) = TTMP
<span class="comm">*     STEPR(I) = MIN(1.4*STEPR(I),DTR1)
</span><span class="comm">*
</span>  110 <span class="kw">IF</span> (TTMP.LT.STEP(I)) <span class="kw">THEN</span>
          STEP(I) = 0.5D0*STEP(I)
          TIMENW(I) = T0(I) + STEP(I)
          NICONV = NICONV + 1
          GO TO 110
      <span class="kw">END</span> <span class="kw">IF</span>
<span class="comm">*
</span>  120 <span class="kw">RETURN</span>
<span class="comm">*
</span>      <span class="kw">END</span>
</pre>
            
          </td>
        </tr>
      </tbody>
    </table>
  </body>
</html>
